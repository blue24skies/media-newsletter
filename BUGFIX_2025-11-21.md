# üêõ Bugfix: Newsletter l√§dt nicht & Archiv ist leer & Horizont Feed falsch

**Datum:** 21.11.2025  
**Status:** ‚úÖ BEHOBEN

## üîç Probleme

### Problem 1: Newsletter l√§dt nicht beim ersten √ñffnen
**Symptom:** 
- Email-Link f√ºhrt zu Seite mit "0 Artikel heute" und "NaN √∏ Score"
- Erst nach Klick auf "Aktueller Newsletter" werden Artikel geladen

**Ursache:**
- Email enthielt Link mit `?date=2025-11-21` Parameter
- Browser-Code versucht bei `?date=` Parameter aus Supabase zu laden
- Aber Supabase war leer (siehe Problem 2)
- Fehler f√ºhrt zu leerer Seite

### Problem 2: Archiv ist komplett leer
**Symptom:**
- Keine alten Newsletter im Archiv sichtbar
- Obwohl System seit Tagen l√§uft

**Ursache:**
- **SUPABASE_URL und SUPABASE_KEY fehlten im GitHub Actions Workflow!**
- Dadurch wurde die Archivierung nie ausgef√ºhrt
- Artikel wurden nur in JSON gespeichert, nicht in Datenbank

### Problem 3: Horizont RSS Feed falsch
**Symptom:**
- Horizont Medien-Artikel werden nicht abgerufen
- Feed-URL gibt 404 oder andere Fehler

**Ursache:**
- Alte Feed-URL: `https://www.horizont.net/feed/kategorie/medien/rss.xml`
- Diese URL existiert nicht mehr (Website-Relaunch)
- Neue korrekte URL: `https://www.horizont.net/news/feed/medien/`

## ‚úÖ L√∂sungen

### Fix 1: Email-Link korrigiert
**Datei:** `medien_newsletter_web.py` (Zeile 888)

**Vorher:**
```python
newsletter_link = f"{NEWSLETTER_URL}?date={datum}"
```

**Nachher:**
```python
newsletter_link = f"{NEWSLETTER_URL}"
```

**Effekt:**
- Newsletter l√§dt jetzt direkt die JSON-Datei des aktuellen Tages
- Kein Umweg √ºber Supabase n√∂tig
- Funktioniert auch wenn Supabase mal ausf√§llt

### Fix 2: Supabase-Secrets zu GitHub Actions hinzugef√ºgt
**Datei:** `.github/workflows/newsletter.yml` (Zeile 34-42)

**Hinzugef√ºgt:**
```yaml
env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
```

**Effekt:**
- Ab dem n√§chsten Newsletter-Run werden Artikel im Archiv gespeichert
- Duplikat-Erkennung funktioniert
- Historische Newsletter k√∂nnen im Archiv angeschaut werden

### Fix 3: Horizont RSS Feed URL korrigiert
**Datei:** `medien_newsletter_web.py` (Zeile 38)

**Vorher:**
```python
'Horizont Medien': 'https://www.horizont.net/feed/kategorie/medien/rss.xml',
```

**Nachher:**
```python
'Horizont Medien': 'https://www.horizont.net/news/feed/medien/',
```

**Effekt:**
- Horizont Medien-Artikel werden wieder abgerufen
- Eine der wichtigsten deutschen Medien-Quellen ist wieder aktiv

## üìã Next Steps

### 1. Code zu GitHub pushen
```bash
git add medien_newsletter_web.py
git add .github/workflows/newsletter.yml
git commit -m "üêõ Fix: Newsletter-Loading & Archiv-Integration & Horizont Feed"
git push origin main
```

### 2. GitHub Secrets pr√ºfen
Stelle sicher, dass diese Secrets gesetzt sind:
- ‚úÖ `ANTHROPIC_API_KEY`
- ‚úÖ `GMAIL_USER`
- ‚úÖ `GMAIL_APP_PASSWORD`
- ‚úÖ `NEWSLETTER_URL`
- ‚úÖ `BRAVE_SEARCH_API_KEY`
- ‚ö†Ô∏è `SUPABASE_URL` - **PR√úFEN!**
- ‚ö†Ô∏è `SUPABASE_KEY` - **PR√úFEN!**

Wo pr√ºfen: GitHub ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions

### 3. Manuellen Test durchf√ºhren (optional)
```bash
# Lokaler Test mit allen Umgebungsvariablen:
export ANTHROPIC_API_KEY="dein-key"
export GMAIL_USER="dein-email"
export GMAIL_APP_PASSWORD="dein-password"
export NEWSLETTER_URL="https://blue24skies.github.io/media-newsletter"
export BRAVE_SEARCH_API_KEY="dein-key"
export SUPABASE_URL="https://nrngjnfcfzpxheersplp.supabase.co"
export SUPABASE_KEY="dein-key"

python medien_newsletter_web.py
```

Erwartete Ausgabe:
```
‚úÖ Supabase verbunden - Archiv aktiv
üíæ ARCHIVIERE X ARTIKEL
‚úì Artikel 1...
‚úì Artikel 2...
‚úÖ X/X Artikel archiviert
```

### 4. Warte auf morgigen Newsletter
- Morgen um 7:00 Uhr l√§uft der Newsletter automatisch
- Mit den Fixes sollte alles funktionieren
- Die Artikel werden dann im Archiv gespeichert

### 5. Alte Newsletter nachtr√§glich archivieren (optional)
Da die alten Newsletter nur als JSON existieren, aber nicht im Archiv:

**Option A:** Akzeptieren dass alte Newsletter (13.-21.11.) nur via JSON verf√ºgbar sind

**Option B:** Script schreiben um alte JSONs ins Archiv zu importieren

## üîÆ Erwartete Verbesserungen

### Ab morgen (22.11.2025):
‚úÖ Newsletter-Link √∂ffnet direkt mit Artikeln  
‚úÖ Artikel werden im Archiv gespeichert  
‚úÖ Duplikat-Erkennung aktiv  
‚úÖ Archiv-Seite zeigt neue Newsletter  
‚úÖ Horizont Medien-Artikel werden wieder abgerufen  

### Alte Newsletter (13.-21.11.):
‚ö†Ô∏è Weiterhin √ºber JSON verf√ºgbar  
‚ö†Ô∏è Nicht im Archiv  
‚ö†Ô∏è K√∂nnen bei Bedarf nachtr√§glich importiert werden  

## üìä Technische Details

### Warum funktionierten JSON-Newsletter?
Die JSON-Dateien wurden immer korrekt erstellt und nach GitHub Pages gepusht. Deshalb funktionierte der "Aktueller Newsletter" Button - er l√§dt die JSON des heutigen Tages ohne Umweg √ºber Supabase.

### Warum schlug Supabase-Loading fehl?
1. Email-Link hatte `?date=` Parameter
2. Browser-Code sah Parameter ‚Üí versuchte Supabase-Loading
3. Supabase war leer (Secrets fehlten)
4. Error-Handling zeigte "0 Artikel"

### Warum war Supabase leer?
GitHub Actions hatte keine `SUPABASE_URL` und `SUPABASE_KEY` Environment Variables. Deshalb gab das Python-Script diese Meldung aus:
```
‚ö†Ô∏è Supabase nicht verf√ºgbar - Archiv deaktiviert
```

Aber weil das Script trotzdem weiter lief und JSON + Email erstellte, wurde das Problem nicht sofort bemerkt.

## üéØ Lessons Learned

1. **Environment Variables komplett checken** - Nicht nur pr√ºfen ob Script l√§uft, sondern auch ob alle Features aktiv sind
2. **Logging verbessern** - Supabase-Fehler sollte prominenter sein (nicht nur ‚ö†Ô∏è)
3. **Integration Tests** - Email-Links sollten getestet werden bevor sie versendet werden
4. **Archiv-Monitoring** - Nach jedem Run pr√ºfen ob Artikel wirklich im Archiv landen

## ‚úÖ Verification Checklist

Nach dem n√§chsten Newsletter-Run (morgen 7:00 Uhr):

- [ ] Email erhalten
- [ ] Link √∂ffnet Newsletter direkt (ohne "0 Artikel")
- [ ] Artikel werden angezeigt
- [ ] Im Archiv taucht der neue Newsletter auf
- [ ] Duplikat-Check funktioniert (Log pr√ºfen)
- [ ] Statistiken in Supabase sind vorhanden

---

**Ende der Bugfix-Dokumentation**
