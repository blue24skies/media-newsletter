name: Weekly Learning Analysis

on:
  schedule:
    # L√§uft jeden Sonntag um 22:00 Uhr Berlin Zeit (21:00 UTC im Winter, 20:00 UTC im Sommer)
    - cron: '0 21 * * 0'
  workflow_dispatch: # Erm√∂glicht manuelles Ausl√∂sen f√ºr Tests

# WICHTIG: GitHub Actions braucht write-Rechte f√ºr git push!
permissions:
  contents: write

jobs:
  analyze-feedback:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install anthropic supabase
    
    - name: Run Weekly Analysis
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        echo "üß† Starte w√∂chentliche Learning-Analyse..."
        python weekly_analysis.py
        
        echo ""
        echo "üìä Pr√ºfe ob neue Regeln generiert wurden..."
        if [ -f learning_rules.py ]; then
          echo "‚úÖ learning_rules.py gefunden"
          echo ""
          echo "=== Inhalt (erste 50 Zeilen) ==="
          head -n 50 learning_rules.py
          echo "================================"
        else
          echo "‚ö†Ô∏è learning_rules.py nicht gefunden"
        fi
    
    - name: Commit and Push Learning Rules
      run: |
        git config user.name "Learning Bot"
        git config user.email "learning-bot@zooproductions.de"
        
        # F√ºge learning_rules.py hinzu
        git add learning_rules.py
        
        # Commit nur wenn es √Ñnderungen gibt
        if git diff --staged --quiet; then
          echo "‚ÑπÔ∏è Keine √Ñnderungen an Learning Rules"
        else
          git commit -m "üß† Update Learning Rules ($(date +%Y-%m-%d))"
          git push
          echo "‚úÖ Learning Rules aktualisiert und gepusht"
        fi
