name: Daily Newsletter Generation

on:
  schedule:
    # LÃ¤uft tÃ¤glich um 7:00 Uhr Berlin Zeit (6:00 UTC im Winter, 5:00 UTC im Sommer)
    - cron: '0 6 * * *'
  workflow_dispatch: # ErmÃ¶glicht manuelles AuslÃ¶sen

# WICHTIG: GitHub Actions braucht write-Rechte fÃ¼r git push!
permissions:
  contents: write

jobs:
  generate-newsletter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run Newsletter Script
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GMAIL_USER: ${{ secrets.GMAIL_USER }}
        GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
        NEWSLETTER_URL: ${{ secrets.NEWSLETTER_URL }}
        BRAVE_SEARCH_API_KEY: ${{ secrets.BRAVE_SEARCH_API_KEY }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      run: |
        python medien_newsletter_web.py
        
        # Erstelle docs/ Verzeichnis wenn nicht vorhanden
        mkdir -p docs
        
        # Kopiere index.html und Logos ins docs/ Verzeichnis
        cp index.html docs/ 2>/dev/null || true
        cp logo-*.png docs/ 2>/dev/null || true
        
        # Kopiere Fonts ins docs/ Verzeichnis
        mkdir -p docs/fonts
        cp fonts/*.woff2 docs/fonts/ 2>/dev/null || true
        
        # Verschiebe JSON-Dateien ins docs/ Verzeichnis fÃ¼r GitHub Pages
        mv newsletter-*.json docs/ 2>/dev/null || true
        
        # Liste was erstellt wurde
        echo "=== Dateien in docs/ ==="
        ls -la docs/
        echo "=== Fonts in docs/fonts/ ==="
        ls -la docs/fonts/ 2>/dev/null || echo "Keine Fonts gefunden"
    
    - name: Commit and Push Newsletter Data
      run: |
        git config user.name "Newsletter Bot"
        git config user.email "newsletter-bot@zooproductions.de"
        
        # FÃ¼ge ALLE Dateien im docs/ Ordner hinzu (auch neue!) - FIX!
        git add -A docs/
        
        # Commit nur wenn es Ã„nderungen gibt
        git diff --staged --quiet || git commit -m "ðŸ“° Newsletter $(date +%Y-%m-%d)"
        
        # Push zu GitHub
        git push
